<title>IMEI维护 - 笑享租</title>

<!--列表样式信息-->
<link rel="stylesheet" href="/erp/assets/css/ui.jqgrid.css"/>
<link rel="stylesheet" href="/erp/assets/css/chosen.css" />

<div class="row">
    <div class="col-xs-12">
        <div class="space-6"></div>
        <div class="well">
            <form id="queryForm" class="form-horizontal">
                <div class="form-group">
                    <div class="col-xs-3">
                        <label class="col-sm-3 control-label no-padding-right">IMEI号:</label>
                        <div class="col-sm-9">
                            <input type="text"  name="imei_no" class="form-control"/>
                        </div>
                    </div>

                    <div class="col-xs-3">
                        <label class="col-sm-3 control-label no-padding-right">产品:</label>
                        <div class="col-sm-9">
                            <select id="product_id" name="product_id" class="form-control chosen-select">
                            </select>
                        </div>
                    </div>

                    <div class="col-xs-3">
                        <label class="col-sm-3 control-label no-padding-right">产品详细:</label>
                        <div class="col-sm-9">
                            <select disabled id="sku_id" name="sku_id" class="form-control chosen-select" data-placeholder="请先选择产品">
                            </select>
                        </div>
                    </div>

                    <div class="col-xs-3">
                        <button class="btn btn-primary" type="button" onclick="queryData()">
                            <i class="ace-icon fa fa-search bigger"></i>
                            查询
                        </button>
                        <button class="btn" type="reset" onclick="resetForm()">
                            <i class="ace-icon fa fa-refresh bigger"></i>
                            重置
                        </button>
                    </div>
                </div>
            </form>
        </div>
        <div class="space-12"></div>
        <div class="fc-button-group" style="margin-left: 5px;">
            <a id="imei_add" data-rel="tooltip" title="" data-original-title="新增" href="javascript:void(0)" style="padding: 2px;"><i class="ace-icon fa fa-plus-circle purple bigger-125"></i></a>
            <a id="imei_edit" data-rel="tooltip" title="" data-original-title="修改" href="javascript:void(0)" style="padding: 2px;"><i class="ace-icon fa fa-pencil blue bigger-125"></i></a>
            <a id="imei_del" data-rel="tooltip" title="" data-original-title="删除" href="javascript:void(0)" style="padding: 2px;"><i class="ace-icon fa fa-trash-o red bigger-125"></i></a>
        </div>

        <table id="grid-table"></table>
        <div id="grid-pager"></div>
    </div><!-- /.col -->
</div>

<script>
    var scripts = [null, "/erp/assets/js/date-time/bootstrap-datepicker.js",
        "/erp/assets/js/jqGrid/jquery.jqGrid.custom.js",
        "/erp/assets/js/chosen.jquery.js",
        "/erp/assets/js/jqGrid/i18n/grid.locale-cn.js", null]

    var grid_selector = "#grid-table";
    var pager_selector = "#grid-pager";

    function resetForm() {
        $(".chosen-select").val('').trigger("chosen:updated");
    }

    //查询表单数据
    function queryData() {
        var formData = $("#queryForm").serializeJson();
        jQuery(grid_selector).jqGrid("setGridParam", {postData: formData}).trigger("reloadGrid", [{page: 1}]);
    }
    //添加IMEI
    $("#imei_add").click(function(){
        toCustomUrl('page/product/imeiindetail.jsp');
    });
    //修改IMEI
    $("#imei_edit").click(function(){
        var ids = $(grid_selector).jqGrid('getGridParam','selarrrow');
        if(!ids || ids.length === 0) {
            showWarnInfo("请先选择一条记录", 3000);
        }else if(ids.length>1) {
            showWarnInfo("只能选择一条记录进行修改", 3000);
        }else{
            toCustomUrl("server/product/toImeiDetail?id="+ids[0]);
        }
    });
    //删除IMEI
    $("#imei_del").click(function(){
        var ids = $(grid_selector).jqGrid('getGridParam','selarrrow');
        if(!ids || ids.length === 0) {
            showWarnInfo("至少选择一条记录", 3000);
        }else{
            bootbox.confirm("确认删除选中的所有信息？该操作不可逆转", function(res) {
                if(res) {
                    myAjax("/product/delImeiInfo", {ids: ids.join(",")}, function(result){
                        if(result.code == '1') {
                            showSuccInfo("操作成功");
                            queryData();
                        }else{
                            showErrorInfo(result.message);
                        }
                    })
                }
            });
        }
    });

    $('.page-content-area').ace_ajax('loadScripts', scripts, function () {
        $('[data-rel=tooltip]').tooltip();
        //inline scripts related to this page
        jQuery(function ($) {
            var parent_column = $(grid_selector).closest('[class*="col-"]');
            $(window).on('resize.jqGrid', function () {
                $(grid_selector).jqGrid('setGridWidth', parent_column.width());
                $(grid_selector).jqGrid('setGridHeight', $(window).height() - 360);
            });

            //resize on sidebar collapse/expand

            //重新进入时，销毁原有页面信息
            $(document).one('ajaxloadstart.page', function (e) {
                $.jgrid.gridDestroy(grid_selector);
                $('.ui-jqdialog').remove();
            });


            $(grid_selector).jqGrid({
                url: projectUrl + "/product/getLineImeiInfo", //获取所用用户信息
                datatype: "json",
                mtype: 'POST',
                height: $(window).height() - 360,
                colNames: ['ID', '状态', '商品名', '商品描述', 'IMEI号', '操作人', '操作时间'],
                colModel: [
                    {name: 'imei_id', index:'imei_id', key: true, width: 60, hidden: true, frozen: true, editable: true},
                    {name: 'state', index:'state',  width:100, formatter: pickState},
                    {name: 'product_name', index:'product_name', width: 200},
                    {name: 'product_desc', index:'product_desc',  width:200},
                    {name: 'imei_no', index:'imei_no',  width:200},
                    {name: 'crtuser', width: 150},
                    {name: 'crtdate', width: 150},
                ],
                sortname: 'crtdate',
                sortorder: 'desc',
                viewrecords: true,
                rowNum: 10,
                rowList: [10, 20, 30],
                pager: pager_selector,
                autowidth: true,
                autoScroll: false,
                shrinkToFit: false,
                multiselect: true,
                multiboxonly: true,
                loadError: function (xhr, status, error) {
                    showErrorInfo("服务异常;"+error);
                },
            });

            function pickState(val) {
                if(val === 2) {
                    return '已出库';
                }else if(val === 1){
                    return '尚未出库';
                }else if(val === 3) {
                    return '锁定中'
                }
            }

            $("#product_id").change(function(){
                if(!$(this).val()) {
                    $("#sku_id").attr("disabled", "disabled");
                    $("#sku_id").val('').trigger("chosen:updated");
                }else{
                    $("#sku_id").removeAttr("disabled");
                    myAjax("/product/getSkuProductByPid", {product_id: $(this).val()}, function(result) {
                        var data = result.data;
                        var html = '<option value="">&nbsp;</option>';
                        data.forEach(function (info) {
                            html += '<option value="' + info.sku_id + '">' + info.product_desc + '</option>';
                        });
                        $("#sku_id").html(html);
                        $("#sku_id").trigger("chosen:updated");
                    })
                }
            });

            /**
             * 设置选择框
             */
            $("#product_id").chosen({allow_single_deselect: true});
            $("#sku_id").chosen({allow_single_deselect: true});
            var depObj = [];
            var allDep = "";
            myAjax("/product/getAllProduct", null, function (result) {
                if (result.code == 1) {
                    depObj = result.data;
                    allDep = toSelectData(result.data, "product_id", "product_desc");
                    //设置选择框中信息
                    createDepSelect(result.data);
                } else {
                    showErrorInfo(result.message);
                }
            });

            function createDepSelect(data) {
                var html = '<option value="">&nbsp;</option>';
                data.forEach(function (info) {
                    html += '<option value="' + info.product_id + '">' + info.product_desc + '</option>';
                });
                $("#product_id").html(html);
                $("#product_id").trigger("chosen:updated");
            }

            $(document).on('settings.ace.chosen', function (e, event_name, event_val) {
                if (event_name != 'sidebar_collapsed') return;
                $('#product_id').each(function () {
                    var $this = $(this);
                    $this.next().css({'width': $this.parent().width()});
                })
            });

            // Jq_operationButton();
            //底部操作按钮
            function Jq_operationButton() {
                var grid_selector = "#grid-table";
                var pager_selector = "#grid-pager";
                jQuery(grid_selector).jqGrid('navGrid', pager_selector,
                    { 	//navbar options
                        edit: true,
                        editicon: 'ace-icon fa fa-pencil blue',
                        add: true,
                        addicon: 'ace-icon fa fa-plus-circle purple',
                        del: true,
                        delicon: 'ace-icon fa fa-trash-o red',
                        search: false,
                        // searchicon: 'ace-icon fa fa-search orange',
                        refresh: true,
                        refreshicon: 'ace-icon fa fa-refresh green',
                        view: false,
                        viewicon: 'ace-icon fa fa-search-plus grey',
                    },
                    {  //编辑
                        recreateForm: true,
                        closeAfterEdit: true,
                        afterSubmit: function(response) {
                            var result = response.responseJSON;
                            if(result.code === 1) {
                                return [true] ;
                            }else{
                                return [false, result.message];
                            }
                        }
                    },
                    { //添加
                        closeAfterAdd: true,
                        recreateForm: true,
                        viewPagerButtons: false,

                    },
                    { //删除
                        recreateForm: true,
                    }
                )
            }
        })
    })

</script>