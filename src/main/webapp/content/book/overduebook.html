<title>订单催收 - 笑享租</title>

<!--列表样式信息-->
<link rel="stylesheet" href="/erp/assets/css/ui.jqgrid.css"/>
<link rel="stylesheet" href="/erp/assets/css/chosen.css" />

<div class="row">
    <div class="col-xs-12">
        <div class="space-6"></div>
        <div class="well">
            <form id="queryForm" class="form-horizontal">
                <div class="form-group">
                    <div class="col-xs-3">
                        <label for="book_no" class="col-sm-3 control-label no-padding-right">订单号:</label>
                        <div class="col-sm-9">
                            <input type="text" id="book_no" name="book_no" class="form-control"/>
                        </div>
                    </div>

                    <div class="col-xs-3">
                        <label for="book_phone" class="col-sm-3 control-label no-padding-right">客户手机:</label>
                        <div class="col-sm-9">
                            <input type="text" id="book_phone" name="phone" class="form-control"/>
                        </div>
                    </div>


                    <div class="col-xs-3">
                        <label for="agency_id" class="col-sm-3 control-label no-padding-right">代理商:</label>
                        <div class="col-sm-9">
                            <!--<input type="text" id="agency_id" name="agency_id" class="form-control"/>-->
                            <select id="agency_id" name="agency_id" class="form-control chosen-select">
                            </select>
                        </div>
                    </div>

                    <div class="col-xs-3">
                        <button class="btn btn-primary" type="button" onclick="queryData()">
                            <i class="ace-icon fa fa-search bigger"></i>
                            查询
                        </button>
                        <button class="btn" type="reset" onclick="resetForm()">
                            <i class="ace-icon fa fa-refresh bigger"></i>
                            重置
                        </button>
                    </div>
                </div>
            </form>
        </div>
        <div class="space-12"></div>
        <div class="fc-button-group" style="margin-left: 5px;">
            <a id="overduebook_query" data-rel="tooltip" title="" data-original-title="查看" href="javascript:void(0)" style="padding: 2px;"><i class="ace-icon fa fa-search-plus grey bigger-125"></i></a>

            <a id="zhifb_pay" data-rel="tooltip" title="" data-original-title="下载支付宝账单" href="javascript:void(0)" style="padding: 2px;"><i class="ace-icon fa fa-desktop grey bigger-125"></i></a>
        </div>
        <table id="grid-table"></table>
        <div id="grid-pager"></div>
    </div><!-- /.col -->
</div>

<script>
    var scripts = [null, "/erp/assets/js/date-time/bootstrap-datepicker.js",
        "/erp/assets/js/jqGrid/jquery.jqGrid.custom.js",
        "/erp/assets/js/chosen.jquery.js",
        "/erp/assets/js/x-editable/bootstrap-editable.js",
        "/erp/assets/js/x-editable/ace-editable.js",
        "/erp/assets/js/jquery.maskedinput.js",
        "/erp/assets/js/jqGrid/i18n/grid.locale-cn.js", null]

    var grid_selector = "#grid-table";
    var pager_selector = "#grid-pager";

    function resetForm() {
        $(".chosen-select").val('').trigger("chosen:updated");
    }

    //查询表单数据
    function queryData() {
        var formData = $("#queryForm").serializeJson();
        jQuery(grid_selector).jqGrid("setGridParam", {postData: formData}).trigger("reloadGrid", [{page: 1}]);
    }

    //结清账单
    function finishBookFee(bid, pid) {
        myAjax("/book/queryBookStateWithBid", {bid: bid}, function(result){
            var bookType = result.data ? result.data.book_type : "";
            var msg = "确认结清该期订单费用？";
            if(bookType === "1") {
                msg = "该订单为由租转售， 结清该期订单后，该订单将全部完结，请确认已收清该订单的所有费用？"
            }
            bootbox.confirm(msg, function(res) {
                if(res) {
                    myAjax("/book/finishBookFee", {pid: pid, bid:bid, boot_type: bookType}, function(result){
                        if(result.code == '1') {
                            bootbox.hideAll();
                            showSuccInfo("操作成功");
                            queryData();
                        }else{
                            showErrorInfo(result.message);
                        }
                    })
                }
            });
        })
    }

    function queryRepay(bid, book_type) {
        //查询还款记录
        myAjax("/book/queryRepayByBid", {bid:bid}, function(result){
            var html = "";
            if(book_type == '1') {
                html += '<div class="alert alert-danger center">当前订单为<strong>由租转售</strong>，当期费用为该订单应付的<strong>所有剩余费用</strong></div>';
            }
            html += '<table id="simple-table" class="table table-striped table-bordered table-hover">';
            html += '<thead>';
            html += '<tr>';
            html += '<th>状态</th>';
            html += '<th>第几期</th>';
            html += '<th>每期基础费用</th>';
            html += '<th>逾期费</th>';
            html += '<th>本期总应还</th>';
            html += '<th class="hidden-480">待还款时间</th>';
            html += '<th>';
            html += '<i class="ace-icon fa fa-clock-o bigger-110 hidden-480"></i>';
            html += '实际还款时间';
            html += '</th>';
            html += '<th>短信通知</th>';
            html += '<th width="50">操作</th>';
            html += '</tr>';
            html += '</thead>';
            html += '<tbody>';
            for(var i = 0; i< result.data.length; i++) {
                var data = result.data[i];
                html += '<tr>';
                html += '<td>';
                console.log("状态："+data.state);
                if(data.state === 1) {
                    html += '<span class="grey">已还</span>';
                }else if(data.state === 2) {
                    html += '待还';
                }else if(data.state === 3) {
                    html += '<span class="red2">逾期</span>';
                }else{
                    html += '<span class="grey">尚未开始</span>';
                }
                html += '</td>';
                html +='<td>第'+data.curphase+'期</td>';
                html += '<td>';
                html += data.money;
                html += '</td>';
                html += '<td>'+(data.expectfee?data.expectfee : "")+'</td>';
                html += '<td>';
                html += (data.totalmoney ? data.totalmoney : data.money);
                html += '</td>';
                html += '<td class="hidden-480">' + data.date + '</td>';
                html += '<td>' + (data.realydate?data.realydate:"") + '</td>';
                if(data.issms === '1') {
                    html += '<td>已发送</td>';
                }else{
                    html += '<td>尚未发送</td>';
                }
                if(data.state === 2 || data.state ===3 || data.state === 4) {
                    html += '<td><a style="cursor: pointer" onclick="finishBookFee('+bid+', '+data.pid+')">结清</a></td>'
                }else{
                    html += '<td></td>';
                }
                html += '</tr>';
                if(data.state === 3 && book_type == '1') {
                    //如果当前订单为由租转售， 那么就不在展示之后的期
                    break;
                }
            }
            html += '</tbody>';
            html += '</table>';
            if(result.data.length === 0) {
                html += '<div class="center orange">还没有还款记录</div>';
            }
            bootbox.dialog({
                message: html,
                className: 'mydialog-width'
            })
        })
    }

    $('.page-content-area').ace_ajax('loadScripts', scripts, function () {
        $('[data-rel=tooltip]').tooltip();
        //inline scripts related to this page
        jQuery(function ($) {
            var parent_column = $(grid_selector).closest('[class*="col-"]');
            $(window).on('resize.jqGrid', function () {
                $(grid_selector).jqGrid('setGridWidth', parent_column.width());
                $(grid_selector).jqGrid('setGridHeight', $(window).height() - 360);
            });
            //resize on sidebar collapse/expand

            //重新进入时，销毁原有页面信息
            $(document).one('ajaxloadstart.page', function (e) {
                $.jgrid.gridDestroy(grid_selector);
                $('.ui-jqdialog').remove();
            });

            $(grid_selector).jqGrid({
                url: projectUrl + "/book/getoverDueBookList", //获取逾期订单信息
                datatype: "json",
                mtype: 'POST',
                height: $(window).height() - 360,
                colNames: ['ID', '租售类型', '订单状态', '还款记录', '订单开始时间', '逾期天数', '距离还款日（天）',
                    '当前逾期费用', '历史总逾期费用', '已还期数', '当前应还金额', '应还款日',
                    '历史还款金额','代理商', '代理城市',
                    '客户类型', '姓名', '电话', '订单号',  '产品名称', '产品价值', '租期', '每期租金',
                    '性别', '出生年月', '民族', '身份证', '籍贯', '家庭电话', '户籍地址', '现地址', '微信号', 'QQ号', '邮箱',
                    '姓名（亲属一）','性别（亲属一）', '关系（亲属一）', '手机（亲属一）', '地址（亲属一）',
                    '姓名（亲属二）','性别（亲属二）', '关系（亲属二）', '手机（亲属二）', '地址（亲属二）'],
                colModel: [
                    {name: 'bid', key: true, width: 60, hidden: true, frozen: true},
                    {name: 'book_type', width:100, formatter: pickBookType},
                    {name: 'state_name', width:100, formatter: pickState},
                    {name: 'repaylssue', width: 150, formatter: pickRepay},
                    {name: 'startdate', width: 150},
                    {name: 'overduenum', width: 150, formatter:pickOverdueNum},
                    {name: 'distancenum', width: 150, formatter:pickDistancenum},
                    {name: 'expectfee', width: 150},
                    {name: 'totalexpectfee', width: 150},
                    {name: 'repaylssue', width: 100, formatter: pickLssue},
                    {name: 'repaytotal', width: 100},
                    {name: 'repaydate', width: 100},
                    {name: 'reimbursement', width: 150},
                    {name: 'agency_name', width:150},
                    {name: 'agency_city', width: 100},
                    {name: 'type', width: 100, formatter: pickType},
                    {name: 'name', width: 100, editable: true},
                    {name: 'phone', width: 100, editable: true},
                    {name: 'book_no', width: 100, editable: true},
                    {name: 'product_name', width: 100, editable: true},
                    {name: 'product_price', width: 100, editable: true},
                    {name: 'leaseterm', width: 120, editable: true},
                    {name: 'monthrent', width: 100, editable: true},
                    {name: 'sex', width: 200, editable: true},
                    {name: 'birth', width: 150, editable: true},
                    {name: 'ethnic', width: 100, editable: true},
                    {name: 'identity', width: 100, editable: true},
                    {name: 'place', width: 100, editable: true},
                    {name: 'familyphone', width: 100, editable: true},
                    {name: 'koseki', width: 150, editable: true},
                    {name: 'nowaddress', width: 150, editable: true},
                    {name: 'weixin', width: 100, editable: true},
                    {name: 'qq', width: 100, editable: true},
                    {name: 'email', width: 100, editable: true},
                    {name: 'family_linkone', width: 120, editable: true},
                    {name: 'family_linkone_sex', width: 120, editable: true},
                    {name: 'family_linkone_relation', width: 120, editable: true},
                    {name: 'family_linkone_phone', width: 120, editable: true},
                    {name: 'family_linkone_address', width: 120, editable: true},
                    {name: 'family_linktwo', width: 120, editable: true},
                    {name: 'family_linktwo_sex', width: 120, editable: true},
                    {name: 'family_linktwo_relation', width: 120, editable: true},
                    {name: 'family_linktwo_phone', width: 120, editable: true},
                    {name: 'family_linktwo_address', width: 120, editable: true},
                ],
                sortname: 'repaydate',
                sortorder: '',
                ondblClickRow: queryDetail,
                viewrecords: true,
                rowNum: 10,
                rowList: [10, 20, 30],
                pager: pager_selector,
                autowidth: true,
                autoScroll: false,
                shrinkToFit: false,
                multiselect: true,
                multiboxonly: true,
                loadError: function (xhr, status, error) {
                    showErrorInfo("服务异常;"+error);
                },
            });
            //距离还款日天数
            function pickDistancenum(val, row, rowdata) {
                var repaydate = rowdata.repaydate;
                if(repaydate) {
                    var date = Date.parse(repaydate.replace(/-/g,  "/"));
                    var num = getOffsetDays(date, new Date());
                    if(num > 0) {
                        return num + "天"
                    }
                }
                return "0";
            }

            //逾期天数
            function pickOverdueNum(val, row, rowdata) {
                var repaydate = rowdata.repaydate;
                if(repaydate) {
                    var date = Date.parse(repaydate.replace(/-/g,  "/"));
                    var num = getFlootDays(new Date(), date);
                    if(num > 0) {
                        return num + "天"
                    }
                }
                return "";
            }

            function getOffsetDays(time1, time2) {
                var offsetTime = time1 - time2;
                return Math.ceil(offsetTime / (3600 * 24 * 1e3));
            }

            function getFlootDays(time1, time2) {
                var offsetTime = time1 - time2;
                return Math.floor(offsetTime / (3600 * 24 * 1e3));
            }

            //租售类型
            function pickBookType(val) {
                if(val == '1') {
                    return '<span class="red2">由租转售</span>';
                }else {
                    return '<span class="orange">租</span>';
                }
            }
            //还款记录查看
            function pickRepay(val, row, rowData) {
                val = val ? val : "0";
                return '<span class="grey">已还'+val+'期</span><span class="btn btn-link" onclick="queryRepay('+row.rowId+', '+rowData.book_type+')">结算</span>';
            }

            function pickLssue(val) {
                val = val ? val : "0";
                return val + '期';
            }

            function pickType(val) {
                console.log(val);
                if(val == '1') {
                    return '学生';
                }else{
                    return '成人';
                }
            }
            //订单状态
            function pickState(val) {
                var statename = 'label-info';
                if(val === '已结清') {
                    statename = 'label-success';
                }else if(val === '已失效') {
                    statename = 'label-danger';
                }else if(val === '已逾期') {
                    statename = 'label-warning';
                }
                return '<span class="label label-sm '+statename+'">'+val+'</span>';
            }
            function pickFileData(val) {
                if(val) {
                    return '<button class="btn btn-link">下载</button>'
                }else{
                    return '<span class="grey">无</span>'
                }
            }


            //修改数据
            $("#overduebook_query").on("click", function(){
                var ids = $(grid_selector).jqGrid('getGridParam','selarrrow');
                if(!ids || ids.length === 0) {
                    showWarnInfo("请先选择一条记录", 3000);
                }else if(ids.length>1) {
                    showWarnInfo("只能选择一条记录进行修改", 3000);
                }else{
                    toCustomUrl("server/book/toOverdueBookDetail?id="+ids[0]);
                }
            });

            //下载支付宝账单
            $("#zhifb_pay").on("click", function(){
                var html = "";
                html += "<input class=\"form-control date-picker\" id='zhifb_date' type=\"text\" data-date-format=\"yyyy-mm-dd\"  placeholder=\"请选择要下载的当天账单\">";
                bootbox.dialog({
                    title: '选择账单日期',
                    message: html,
                    buttons: {
                        ok: {
                            callback: function () {
                                myAjax("/upload/downZhifBill", {
                                    date: $("#zhifb_date").val()
                                }, function (result) {
                                    if(result.code===0) {
                                        showInfo(result.message);
                                    }else{
                                        window.open(result.data);
                                    }
                                })
                            }
                        }
                    }
                });
                //设置日期选择样式
                $('.date-picker').datepicker({
                    autoclose: true,
                    todayHighlight: true
                });
            });

            function queryDetail(id) {
                toCustomUrl("server/book/toOverdueBookDetail?id="+id);
            }

            /**
             * 设置选择框
             */
            $("#agency_id").chosen({allow_single_deselect:true});
            var depObj = [];
            var allDep = "";
            myAjax("/base/getAllAgency", null, function(result){
                if(result.code == 1) {
                    depObj = result.data;
                    allDep = toSelectData(result.data, "aid", "aname");
                    //设置选择框中信息
                    createDepSelect(result.data);
                }else{
                    showErrorInfo(result.message);
                }
            });

            function createDepSelect(data) {
                var html = '<option value="">&nbsp;</option>';
                data.forEach(function(info) {
                    html += '<option value="'+info.aid+'">'+info.aname+'</option>';
                });
                $("#agency_id").html(html);
                $("#agency_id").trigger("chosen:updated");
            }

            $(document).on('settings.ace.chosen', function(e, event_name, event_val) {
                if(event_name != 'sidebar_collapsed') return;
                $('#agency_id').each(function() {
                    var $this = $(this);
                    $this.next().css({'width': $this.parent().width()});
                })
            });

        })
    })

</script>