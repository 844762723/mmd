<title>订单审核 - 笑享租</title>

<!--列表样式信息-->
<link rel="stylesheet" href="/erp/assets/css/ui.jqgrid.css"/>
<link rel="stylesheet" href="/erp/assets/css/chosen.css"/>

<div class="row">
    <div class="col-xs-12">
        <div class="space-6"></div>
        <div class="well">
            <form id="queryForm" class="form-horizontal">
                <div class="form-group">
                    <div class="col-xs-2">
                        <label for="book_no" class="col-sm-3 control-label no-padding-right">订单号:</label>
                        <div class="col-sm-9">
                            <input type="text" id="book_no" name="book_no" class="form-control"/>
                        </div>
                    </div>

                    <div class="col-xs-3">
                        <label for="book_phone" class="col-sm-4 control-label no-padding-right">客户手机:</label>
                        <div class="col-sm-8">
                            <input type="text" id="book_phone" name="phone" class="form-control"/>
                        </div>
                    </div>

                    <div class="col-xs-2">
                        <label for="audit_state" class="col-sm-4 control-label no-padding-right">订单状态:</label>
                        <div class="col-sm-8">
                            <!--<input type="text" id="book_state" name="state" class="form-control"/>-->
                            <select class="form-control" id="audit_state" name="audit_state">
                                <option value="" selected></option>
                                <option value="1">待初审</option>
                                <option value="7">待复审</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-xs-3">
                        <label for="agency_id" class="col-sm-3 control-label no-padding-right">代理商:</label>
                        <div class="col-sm-9">
                            <select id="agency_id" name="agency_id" class="form-control chosen-select">
                            </select>
                        </div>
                    </div>

                    <div class="col-xs-2">
                        <button class="btn btn-primary" type="button" onclick="queryData()">
                            <i class="ace-icon fa fa-search bigger"></i>
                            查询
                        </button>
                        <button class="btn" type="reset" onclick="resetForm()">
                            <i class="ace-icon fa fa-refresh bigger"></i>
                            重置
                        </button>
                    </div>
                </div>
            </form>
        </div>
        <div class="space-12"></div>
        <div class="fc-button-group" style="margin-left: 5px;">
            <!--<a id="agency_add" data-rel="tooltip" title="" data-original-title="新增" href="javascript:void(0)"-->
               <!--style="padding: 2px;"><i class="ace-icon fa fa-plus-circle purple bigger-125"></i></a>-->
            <a id="agency_query" data-rel="tooltip" title="" data-original-title="查看详细" href="javascript:void(0)"
               style="padding: 2px;"><i class="ace-icon fa fa-search-plus grey bigger-125"></i></a>
        </div>
        <table id="grid-table"></table>
        <div id="grid-pager"></div>
    </div><!-- /.col -->
</div>

<script>
    var scripts = [null, "/erp/assets/js/date-time/bootstrap-datepicker.js",
        "/erp/assets/js/jqGrid/jquery.jqGrid.custom.js",
        "/erp/assets/js/chosen.jquery.js",
        "/erp/assets/js/jqGrid/i18n/grid.locale-cn.js", null]

    var grid_selector = "#grid-table";
    var pager_selector = "#grid-pager";

    //查询表单数据
    function queryData() {
        var formData = $("#queryForm").serializeJson();
        jQuery(grid_selector).jqGrid("setGridParam", {postData: formData}).trigger("reloadGrid", [{page: 1}]);
    }

    function resetForm() {
        $(".chosen-select").val('').trigger("chosen:updated");
    }

    function openBookInfo(bid) {
        //查询列表信息
        toCustomUrl("page/book/bookquery.html?type=queryhistory&bid=" + bid);
    }

    $('.page-content-area').ace_ajax('loadScripts', scripts, function () {

        $('[data-rel=tooltip]').tooltip();
        //inline scripts related to this page
        jQuery(function ($) {
            var parent_column = $(grid_selector).closest('[class*="col-"]');
            $(window).on('resize.jqGrid', function () {
                $(grid_selector).jqGrid('setGridWidth', parent_column.width());
                $(grid_selector).jqGrid('setGridHeight', $(window).height() - 360);
            });
            //resize on sidebar collapse/expand

            //重新进入时，销毁原有页面信息
            $(document).one('ajaxloadstart.page', function (e) {
                $.jgrid.gridDestroy(grid_selector);
                $('.ui-jqdialog').remove();
            });

            $(grid_selector).jqGrid({
                url: projectUrl + "/book/getAuditBookList", //获取所用用户信息
                datatype: "json",
                mtype: 'POST',
                height: $(window).height() - 360,
                colNames: ['ID', '状态ID', '状态', '历史租赁', '代理商', '代理城市', '客户类型', '姓名', '电话', '订单号', '产品名称', '产品价值',
                    '租期', 'IMEI号', '每期租金',
                    '性别', '出生年月', '民族', '身份证', '籍贯',
                    '家庭电话', '户籍地址', '现地址', '微信号', '手机服务密码', 'QQ号', '邮箱', '银行卡号', '银行卡开户行', '备注'],
                colModel: [
                    {name: 'bid', key: true, width: 60, hidden: true, frozen: true},
                    {name: 'audit_state', width: 100, hidden: true},
                    {name: 'audit_state_name', width: 100, formatter: pickAuditName},
                    {name: 'history_count', width: 150, formatter: pickHistroy},
                    {name: 'agency_name', width: 150},
                    {name: 'agency_city', width: 100},
                    {name: 'type', width: 100, formatter: pickType},
                    {name: 'name', width: 100, editable: true},
                    {name: 'phone', width: 100, editable: true},
                    {name: 'book_no', width: 100, editable: true},
                    {name: 'product_name', width: 100, editable: true},
                    {name: 'product_price', width: 100, editable: true},
                    {name: 'leaseterm', width: 120, editable: true},
                    {name: 'product_imei', width: 100, editable: true},
                    {name: 'monthrent', width: 100, editable: true},
                    {name: 'sex', width: 200, editable: true},
                    {name: 'birth', width: 150, editable: true},
                    {name: 'ethnic', width: 100, editable: true},
                    {name: 'identity', width: 100, editable: true},
                    {name: 'place', width: 100, editable: true},
                    {name: 'familyphone', width: 100, editable: true},
                    {name: 'koseki', width: 150, editable: true},
                    {name: 'nowaddress', width: 150, editable: true},
                    {name: 'weixin', width: 100, editable: true},
                    {name: 'phoneserviceno', width: 100, editable: true},
                    {name: 'qq', width: 100, editable: true},
                    {name: 'email', width: 100, editable: true},
                    {name: 'bankcard', width: 100, editable: true},
                    {name: 'bankaddress', width: 150, editable: true},
                    {name: 'memo', width: 200, editable: true},
                ],
                sortname: 'crtdate',
                sortorder: 'desc',
                ondblClickRow: queryDetail,
                viewrecords: true,
                rowNum: 10,
                rowList: [10, 20, 30],
                pager: pager_selector,
                autowidth: true,
                autoScroll: false,
                shrinkToFit: false,
                multiselect: true,
                multiboxonly: true,
                loadError: function (xhr, status, error) {
                    showErrorInfo("服务异常;" + error);
                },
            });

            function pickHistroy(val, row) {
                var html = "";
                html += '<a href="javascript:void(0)" class="btn btn-info btn-xs radius-4" onclick="openBookInfo(' + row.rowId + ')">';
                html += '<i class="ace-icon fa fa-hand-o-right"></i>';
                html += '总数';
                html += '<span class="badge badge-pink">+' + val + '</span>';
                html += '</a>';
                return html;
            }

            function pickType(val) {
                if (val == '1') {
                    return '学生';
                } else {
                    return '成人';
                }
            }

            function pickAuditName(val) {
                if (val === '初审中') {
                    return '<span class="label label-sm label-info">' + val + '</span>';
                } else if (val === '复审中') {
                    return '<span class="label label-sm label-warning">' + val + '</span>';
                } else {
                    return val;
                }
            }

            function pickFileData(val) {
                if (val) {
                    return '<button class="btn btn-link">下载</button>'
                } else {
                    return '<span class="grey">无</span>'
                }
            }

            //新增数据
            $("#agency_add").on("click", function () {
                toCustomUrl('page/agency/agencydet.jsp');
            });
            //修改数据
            $("#agency_query").on("click", function () {
                var ids = $(grid_selector).jqGrid('getGridParam', 'selarrrow');
                if (!ids || ids.length === 0) {
                    showWarnInfo("请先选择一条记录", 3000);
                } else if (ids.length > 1) {
                    showWarnInfo("只能选择一条记录进行修改", 3000);
                } else {
                    toCustomUrl("server/book/toBookAuditDetail?id=" + ids[0]);
                }
            });

            function queryDetail(id) {
                toCustomUrl("server/book/toBookAuditDetail?id=" + id);
            }

            /**
             * 设置选择框
             */
            $("#agency_id").chosen({allow_single_deselect: true});
            var depObj = [];
            var allDep = "";
            myAjax("/base/getAllAgency", null, function (result) {
                if (result.code == 1) {
                    depObj = result.data;
                    allDep = toSelectData(result.data, "aid", "aname");
                    //设置选择框中信息
                    createDepSelect(result.data);
                } else {
                    showErrorInfo(result.message);
                }
            });

            function createDepSelect(data) {
                var html = '<option value="">&nbsp;</option>';
                data.forEach(function (info) {
                    html += '<option value="' + info.aid + '">' + info.aname + '</option>';
                });
                $("#agency_id").html(html);
                $("#agency_id").trigger("chosen:updated");
            }

            $(document).on('settings.ace.chosen', function (e, event_name, event_val) {
                if (event_name != 'sidebar_collapsed') return;
                $('#agency_id').each(function () {
                    var $this = $(this);
                    $this.next().css({'width': $this.parent().width()});
                })
            });
        })
    })

</script>